jQuery.tableDnD={currentTable:null,dragObject:null,mouseOffset:null,oldY:0,build:function(a){return a=a||{},this.each(function(){this.tableDnDConfig={onDragStyle:a.onDragStyle,onDropStyle:a.onDropStyle,onDragClass:a.onDragClass?a.onDragClass:"tDnD_whileDrag",onDrop:a.onDrop,onDragStart:a.onDragStart,scrollAmount:a.scrollAmount?a.scrollAmount:5},jQuery.tableDnD.makeDraggable(this)}),jQuery(document).bind("mousemove",jQuery.tableDnD.mousemove).bind("mouseup",jQuery.tableDnD.mouseup),this},makeDraggable:function(a){for(var b=a.rows,c=a.tableDnDConfig,d=0;b.length>d;d++){var e=$(b[d]).hasClass("nodrag");e||jQuery(b[d]).mousedown(function(b){return"TD"==b.target.tagName?(jQuery.tableDnD.dragObject=this,jQuery.tableDnD.currentTable=a,jQuery.tableDnD.mouseOffset=jQuery.tableDnD.getMouseOffset(this,b),c.onDragStart&&c.onDragStart(a,this),!1):void 0}).css("cursor","move")}},mouseCoords:function(a){return a.pageX||a.pageY?{x:a.pageX,y:a.pageY}:{x:a.clientX+document.body.scrollLeft-document.body.clientLeft,y:a.clientY+document.body.scrollTop-document.body.clientTop}},getMouseOffset:function(a,b){b=b||window.event;var c=this.getPosition(a),d=this.mouseCoords(b);return{x:d.x-c.x,y:d.y-c.y}},getPosition:function(a){var b=0,c=0;for(0==a.offsetHeight&&(a=a.firstChild);a.offsetParent;)b+=a.offsetLeft,c+=a.offsetTop,a=a.offsetParent;return b+=a.offsetLeft,c+=a.offsetTop,{x:b,y:c}},mousemove:function(a){if(null!=jQuery.tableDnD.dragObject){var b=jQuery(jQuery.tableDnD.dragObject),c=jQuery.tableDnD.currentTable.tableDnDConfig,d=jQuery.tableDnD.mouseCoords(a),e=d.y-jQuery.tableDnD.mouseOffset.y,f=window.pageYOffset;if(document.all&&(document.compatMode!==void 0&&"BackCompat"!=document.compatMode?f=document.documentElement.scrollTop:document.body!==void 0&&(f=document.body.scrollTop)),d.y-f<c.scrollAmount)window.scrollBy(0,-c.scrollAmount);else{var g=window.innerHeight?window.innerHeight:document.documentElement.clientHeight?document.documentElement.clientHeight:document.body.clientHeight;g-(d.y-f)<c.scrollAmount&&window.scrollBy(0,c.scrollAmount)}if(e!=jQuery.tableDnD.oldY){var h=e>jQuery.tableDnD.oldY;jQuery.tableDnD.oldY=e,c.onDragClass?b.addClass(c.onDragClass):b.css(c.onDragStyle);var i=jQuery.tableDnD.findDropTargetRow(b,e);i&&(h&&jQuery.tableDnD.dragObject!=i?jQuery.tableDnD.dragObject.parentNode.insertBefore(jQuery.tableDnD.dragObject,i.nextSibling):h||jQuery.tableDnD.dragObject==i||jQuery.tableDnD.dragObject.parentNode.insertBefore(jQuery.tableDnD.dragObject,i))}return!1}},findDropTargetRow:function(a,b){for(var c=jQuery.tableDnD.currentTable.rows,d=0;c.length>d;d++){var e=c[d],f=this.getPosition(e).y,g=parseInt(e.offsetHeight)/2;if(0==e.offsetHeight&&(f=this.getPosition(e.firstChild).y,g=parseInt(e.firstChild.offsetHeight)/2),b>f-g&&f+g>b){if(e==a)return null;var h=jQuery.tableDnD.currentTable.tableDnDConfig;if(h.onAllowDrop)return h.onAllowDrop(a,e)?e:null;var i=$(e).hasClass("nodrop");return i?null:e}}return null},mouseup:function(){if(jQuery.tableDnD.currentTable&&jQuery.tableDnD.dragObject){var b=jQuery.tableDnD.dragObject,c=jQuery.tableDnD.currentTable.tableDnDConfig;c.onDragClass?jQuery(b).removeClass(c.onDragClass):jQuery(b).css(c.onDropStyle),jQuery.tableDnD.dragObject=null,c.onDrop&&c.onDrop(jQuery.tableDnD.currentTable,b),jQuery.tableDnD.currentTable=null}},serialize:function(){if(jQuery.tableDnD.currentTable){var a="";jQuery.tableDnD.currentTable.id;for(var c=jQuery.tableDnD.currentTable.rows,d=0;c.length>d;d++)a.length>0&&(a+=","),a+=c[d].id;return a}return"Error: No Table id set, you need to set an id on your table and every row"}},jQuery.fn.extend({tableDnD:jQuery.tableDnD.build});